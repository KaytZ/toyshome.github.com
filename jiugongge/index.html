<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>诗词九宫格</title>
		<script src="js/mobilebone.js"></script>
		<link rel="stylesheet" type="text/css" href="css/mobilebone.css"/>
		<link rel="stylesheet" href="css/base.css"/>
		<link rel="stylesheet" href="css/mobileSelect.css" />
		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<script>
			(adsbygoogle = window.adsbygoogle || []).push({google_ad_client: "ca-pub-8023167465237689",enable_page_level_ads: true});
		</script>
	</head>
	<body>
		<div class="wrap">
		<div id="pageHome" class="page out hide tx-c">
			<div class="loading-mask">
				<div class="loading-txt">诗词九宫格</div>
				<div class="loading"></div>
			</div>
			<img src="img/main_logo.png" class="main-logo"/>
			<a class="btn btn-begin" href="#mission">开始</a>
			<a class="btn btn-choose" id="picker">选关</a>
			<!--<a class="btn btn-play" id="music">播放(测试)</a>-->
			<a class="btn btn-more" href="http://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI3NjEyMTE3Mg==&scene=123#wechat_redirect">更多</a>
			<div class="tx-c" style="margin-top:40px;">好七喵书院出品</div>
		</div>
		<div id="mission" class="page out">
			<div class="tx-c ofh relative">
				<span class="missionNum"></span>
				<button class="btn btn-help" onclick="help()">帮助</button>
			</div>
			<div class="words">
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
			</div>
			<!--
            	时间：2017-06-30
            	描述：答题区域
            -->
            <div class="relative">
            	<div class="answer"></div>
            	<img src="img/correct_ico.png" class="result-ico correct-ico" />
            	<img src="img/wrong_ico.png" class="result-ico wrong-ico" />
            </div>
            <div class="tx-c btn-group-ctr">
            	<button class="btn btn-go-pre" onclick="goPre()">上一关</button>
            	<button class="btn btn-go-next" onclick="goNext()">下一关</button>
            	<button class="btn btn-reset" onclick="reset()">清空</button>
            	<button class="btn" onclick="gohome()"><a href="#pageHome">回首页</a></button>
            </div>
		</div>
		<div class="tip hide"></div>
		<!--
        	时间：2017-07-01
        	描述：帮助弹窗
        -->
		<div class="help tx-c" data-pop>
			<img src="img/QRCode.png" class="qr"/>
			<div>长按扫码查看通关秘籍哦！</div>
		</div>
		<!--
        	时间：2017-07-01
        	描述：答对弹窗
        -->
        <div class="correct-pop" data-pop>
			<div class="correct-content tx-c">
				<div class="answer-txt">床前明月光</div>
				<div class="poem-info">【出自】唐·李白 《静夜思》</div>
				<div class="poem-content"></div>
				<div style="font-size: 14px;font-weight: normal;margin-top: 10px;">你会背这首诗吗?</div>
				<div class="tx-c btn-correct-g" style="margin-top: 10px;">
					<div class="relative tx-c">
						<div class="hasSt hide">
							<div  style="color:#F0AD4E;margin-bottom: 6px;" class="recited-precent"></div>
							<div><b>我会背</b></div>
						</div>
						<div class="btn btn-recite" data-operation=1>
							<div>我会背</div>
							<img src="img/1.png" class="add-one"/>
						</div>
					</div>
					<div class="relative tx-c">
						<div class="hasSt hide">
							<div  style="color:#F0AD4E;margin-bottom: 6px;" class="seen-precent"></div>
							<div><b>我见过</b></div>
						</div>
						<div class="btn btn-seen" data-operation=2>
							<div>我见过</div>
							<img src="img/1.png" class="add-one"/>
						</div>
					</div>
					<div class="relative tx-c">
						<div class="hasSt hide">
							<div  style="color:#F0AD4E;margin-bottom: 6px;" class="first-precent"></div>
							<div><b>首次见</b></div>
						</div>
						<div class="btn btn-first-see" data-operation=3>
							<div>首次见</div>
							<img src="img/1.png" class="add-one"/>
						</div>
					</div>
				</div>
			</div>
			<div class="tx-c">
				<button class="btn btn-next" style="font-size: 20px;" onclick="nextMission()">下一关</button>
				<a class="btn btn-gohome  hide" style="font-size: 20px;" href="#pageHome" onclick="gohome()" data-rel="back">返回首页</a>
			</div>
        </div>
		<div class="mask"></div>
		<audio src="music/click.wav" id="click-bg"></audio>
		<audio src="music/wrong.wav" id="wrong-bg"></audio>
		<audio src="music/correct.wav" id="correct-bg"></audio>
		<ins class="adsbygoogle" data-ad-client="ca-pub-8023167465237689"data-ad-slot="7138279852"></ins>
	</div>
		<script src="js/jquery-1.11.1.min.js"></script>
		<script src="js/mobileSelect.js"></script>
		<!--<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>-->
		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<script>
			(adsbygoogle = window.adsbygoogle || []).push({});
		</script>
		<script>	
			window.onload=function(){
				$(".loading-mask").hide();
				$(".adsbygoogle").css("z-index","9998");
				if(location.hash.split("&")[1]=="mission"){
//					chooseMission(unlockedCount);
				}
			}
			//初始化信息请求
			$.ajax({
				type:"get",
				url:"https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxab46b47674714151&redirect_uri=http%3A%2F%2Fquiz.hao7miao.cn%2Fpoetry%2Fapi%2Fv1%2Finit&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect",
//				url:"http://quiz.hao7miao.cn/poetry/api/v1/init?code=oVKRFw03BBlMM_VlYCz-xwPFzFbI",
				async:false,
				success:function(res){
					console.log(res)
				}
			});
			/****Global Variable*****/
			//openid:oVKRFw5rxaIhUem0q0dxLgP9ZWiI,oVKRFw03BBlMM_VlYCz-xwPFzFbI
			var missionCount  = 1000,//总关卡数
				unlockedCount = 7,//已经解锁的关卡数
				openId        = "oVKRFw03BBlMM_VlYCz-xwPFzFbI",
				gridText      = '',//九宫格文本
				answerText    = '', //题目答案
				operation     = 1,//答对弹窗的选择
				voted         = false,//
				missionIndex  = 0; //当前的关卡

			$(".btn,.words-block,.answer").on("click",function(){
				$("#click-bg")[0].play();
			})
			/****** 提示框
			 * str 提示文本
			 * delay 指定秒数后提示消失，单位是毫秒
			 * ******/
			function tip(str,delay){
				var timer=null;
				s = delay||1000; 
				$(".tip").text(str).show();
				clearTimeout(timer)
				timer=setTimeout(function(){
					$(".tip").hide();
				},s)
			}
			//帮助按钮
			var maskHide=false;
			function help(){
				maskHide=true;
				$(".mask").show();
				$(".help").show();
				setTimeout(function(){
					$(".help").addClass("show")
				},0)
			}
			//遮罩层mask
			$(".mask").on("click",function(){
				if(maskHide){
					$(this).hide();
					$("[data-pop]").hide().removeClass("show");
				}
				maskHide=false;
			})
			//返回首页
			function gohome(){
				if(voted==false&&$(".btn-correct-g .active").length==1){
					operation=$(".btn-correct-g .active").attr("data-operation");
					$.ajax({
						type:"get",
						url:"quiz.hao7miao.cn/poetry/api/v1/subject/vote?openid="+openId+"&level="+missionIndex+"&operation="+operation,
						async:false,
						success:function(res){
								console.log(res);
							}
						}
					)
				}
				$(".correct-pop").hide().removeClass("show");
				$(".mask").hide();
				$(".btn-correct-g .active").removeClass("active");
				$(".add-one").hide();
				$(".result-ico").hide().removeClass("show");
				$(".words-block").removeClass("empty").html("<span></span>");
				chooseCount=0;
				chooseMission(unlockedCount)//修复答完最后一题后，用户返回首页按钮后再点击退回到上一页后九宫格点击的bug
			}
			//页面后退的时候重置状态
			window.onhashchange=function(){
				$("[data-pop]").hide();
				$(".mask").hide();
				$(".words-block").removeClass("empty");
				$(".result-ico").hide().removeClass("show");
				$(".answer").removeClass("shake");
				chooseCount=0;
			}
			
			/*******点击关卡格子渲染出对应的题目*******/
			function chooseMission(index){
				//获取题目内容
				var answerBlock='';
					missionIndex = index;
					answerText   = '';
				$.get("quiz.hao7miao.cn/poetry/api/v1/subject/get?level="+missionIndex+"&openid="+openId,function(res){
				console.log(res);
				//判断点击的是否是解锁的关卡
				if(missionIndex<=unlockedCount){
					//gridText 打乱顺序后的九宫格内容
					gridText=res.data.words;
					//将文字填入九宫格
					$(".words-block>span").each(function(index,item){
						$(this).text(gridText[index]);
					})
					//生成答案格子,根据答案长度生成不同的格子数量
					var answerLen = res.data.answerCount;
					for(var i=0;i<answerLen;i++){
						answerBlock+='<div class="answer-words empty"><span></span></div>';
					}
					$(".answer").html(answerBlock);
					$(".missionNum").text("第"+missionIndex+"关");
					setTimeout(function(){
						var imgX=$(".answer-words:last-child").position().left,
							xW  =$(".answer-words").width();
						$(".result-ico").css("left",imgX+xW+4);
					},0)
				}else{
					tip("您选的关卡还未解锁");
				}
				//如果是最后一关,答对题之后的弹窗信息会改变
				if(missionIndex==missionCount){
					$(".btn-gohome").show();
					$(".btn-next").hide();
//					unlockedCount-=1;//修正最后一关答题正确后unlockedCount也会加1的误差
				}else{
					$(".btn-gohome").hide();
					$(".btn-next").show();
				}
				})
			}
			
			var chooseCount=0;//已经选择的字符数
			var selectWords ='';//已经选择的字
				/***判断对错*****/
			function judge(){
				//答案填满后获取答案文字
				if(chooseCount==$(".answer-words").length){
					$(".answer-words").each(function(){
						selectWords+=$(this).text();
					})
					
					$.get("quiz.hao7miao.cn/poetry/api/v1/subject/validate?level="+missionIndex+"&openid="+openId+"&answer="+selectWords,
						function(res){
							console.log(res);
							//sta==0 回答正确
							if(res.sta==0){
								voted=res.data.haveVoted;
								$("#correct-bg")[0].play();
								if(missionIndex==unlockedCount&&unlockedCount<missionCount){
									unlockedCount++;
								}
								//刷新关卡选择的div
								$(".answer-words").addClass("correct");
								$(".result-ico.correct-ico").show();
								setTimeout(function(){
									$(".result-ico.correct-ico").addClass("show");
								},0)
								setTimeout(function(){
									$(".correct-pop").show();
									$(".mask").show();
								},1300)
								setTimeout(function(){
									$(".correct-pop").addClass("show");
								},1400)
								$(".answer-txt").text(selectWords);
								$(".poem-content").html(res.data.poem);
								$(".poem-info").text("【出自】"+res.data.author);
								if(voted){
									$.get("quiz.hao7miao.cn/poetry/api/v1/subject/vote?openid="+openId+"&level="+missionIndex+"&operation=1",
										function(res){
											console.log(res);
											$(".btn-correct-g .btn").hide();
											$(".hasSt").show();
											$(".first-precent").text(res.data.first_percent);
											$(".recited-precent").text(res.data.recited_percent);
											$(".seen-precent").text(res.data.seen_percent);
										}
									)
								}else{
									$(".btn-correct-g .btn").show();
									$(".hasSt").hide();
								}
								$(".mobileSelect").remove();
								createPicker();
						}else{
							$("#wrong-bg")[0].play()
							$(".answer-words").addClass("wrong");
							$(".answer").addClass("shake");
							$(".result-ico.wrong-ico").show();
							setTimeout(function(){
								$(".result-ico.wrong-ico").addClass("show");
							},0)
							tip("答错了,点击下方的格子可以取消")
						}
						selectWords='';
					})
				}
			}

			/********点击九宫格**********/
			$(".words-block").on("click",function(){
				//判断点击的是不是空格子
				if(!$(this).hasClass("empty")&&chooseCount<$(".answer-words").length){
					var thisText=$(this).text();
					$(this).addClass("empty").find("span").on("transitionend",function(){
						if($(this).parent().hasClass("empty")){
							$(this).text("");
						}
					});
					chooseCount++;
					$(".answer-words.empty").eq(0).removeClass("empty")
					.attr("data-word-index",$(this).index()).find("span").text(thisText);
					//判断答案正确
					judge();
//					localStorage.setItem('unlockedCount',unlockedCount);
				}else if(chooseCount==$(".answer-words").length){
					judge();
				}
			})
			
			/******点击答案格子*****/
			$(".answer").on("click",".answer-words",function(){
				if(chooseCount>0&&!$(this).hasClass("empty")){
					$(".result-ico").hide().removeClass("show")
					$(".answer").removeClass("shake");
					$(".answer-words").removeClass("correct wrong");
					chooseCount--;
					var thisText=$(this).text();
					$(this).addClass("empty").find("span").on("transitionend",function(){
						if($(this).parent().hasClass("empty")){
							$(this).text("");
						}
					});
					$(".words-block").eq($(this).attr("data-word-index"))
					.removeClass("empty").find("span").text(thisText);
				}
			})
			//清空
			function reset(){
				$(".result-ico").hide().removeClass("show")
				$(".answer").removeClass("shake");
				chooseCount=0;
				selectWords='';
				var tempArr=[];
				$(".answer-words:not('.empty')").each(function(){
				   tempArr.push($(this).find("span").text())
				})
				$(".words-block.empty").each(function(index,item){
					$(this).removeClass("empty").find("span").text(tempArr[index])
				})
				$(".answer-words").removeClass("correct wrong").addClass("empty");
			}
			//快速跳关
			function goNext(){
				if(missionIndex+1>unlockedCount){
					tip("下一关还未解锁")					
				}else{
					chooseMission(missionIndex+1);
					tip("切换成功")
				}
			}
			function goPre(){
				if(missionIndex-1<1){
					tip("这已经是第一关了")
				}else{
					chooseMission(missionIndex-1);
					tip("切换成功")
				}
			}
			//点击我会背，我见过，首次见
			$(".btn-correct-g").on("click",".btn",function(){
				$(".btn-correct-g .btn").removeClass("active");
				$(".add-one").hide();
				$(this).find(".add-one").show();
				$(this).addClass("active");
			})
			//下一关
			function nextMission(){
				//题目状态变量重置
				chooseCount=0;
//				missionIndex++;
				if(voted==false&&$(".btn-correct-g .active").length==1){
					operation=$(".btn-correct-g .active").attr("data-operation");
					$.ajax({
						type:"get",
						url:"quiz.hao7miao.cn/poetry/api/v1/subject/vote?openid="+openId+"&level="+missionIndex+"&operation="+operation,
						async:false,
						success:function(res){
								console.log(res);
							}
						}
					)
				}
				$(".btn-correct-g .active").removeClass("active");
				$(".add-one").hide();
				$(".result-ico").hide().removeClass("show");
				$(".words-block").removeClass("empty").html("<span></span>");
				chooseMission(missionIndex+1);
				$(".correct-pop").hide().removeClass("show");
				$(".mask").hide();
				if(~~missionIndex+1>missionCount){
					tip("这已经是最后一关了")
				}else{
					tip("这是第"+missionIndex+"关");
				}
			}
		/******点击开始*******/
		$(".btn-begin").on("click",function(){
			$(".words-block").removeClass("empty").html("<span></span>");
			$(".add-one").hide();
			$(".btn-correct-g .active").removeClass("active");
			chooseMission(unlockedCount)
		})
		
			//选关，picker插件
		var isClose=true;
		function createPicker(){
			var numArr=[0,1,2,3,4,5,6,7,8,9];
			var gw = unlockedCount%10;
			var sw = ~~(unlockedCount/10)%10;
			var bw = ~~(unlockedCount/100)%10;
			var qw = ~~(unlockedCount/1000)%10;
			var mobileSelect3 = new MobileSelect({
    			trigger: '#picker',
    			title: '已解锁<span style="color:#FE6C3D">'+unlockedCount+'</span>关',
    			wheels: [
                	{data: numArr},
                	{data: numArr},
                	{data: numArr},
                	{data: numArr}
            	],
    			position:[qw,bw,sw,gw], 
    			transitionEnd:function(indexArr,data){
    				var selectIndex=~~(data.join(""));
    				if(selectIndex>unlockedCount||selectIndex==0){
    					isClose=false;
    					$(".ensure>a").removeAttr("href");
    				}else{
    					isClose=true;
    					$(".ensure>a").attr("href","#mission");
    				}
    			},
    			callback:function(indexArr, data){
    				$("#picker").text("选关");
    				$(".words-block").removeClass("empty").html("<span></span>");
    				$(".add-one").hide();
    				$(".btn-correct-g .active").removeClass("active");
    				missionIndex=~~(data.join(""));
    				if(missionIndex<=unlockedCount&&missionIndex!=0){
						chooseMission(missionIndex);
					}else{
						alert("您选的关卡还未解锁");
					}
    			}
			});
		}
		createPicker();
		</script>
		<!--<script src="js/wx.share.js"></script>-->
	</body>
</html>
	