<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>诗词九宫格</title>
		<script src="js/mobilebone.js"></script>
		<link rel="stylesheet" type="text/css" href="css/mobilebone.css"/>
		<link rel="stylesheet" href="css/base.css"/>
		<link rel="stylesheet" href="css/mobileSelect.css" />
		<!--<script async="" src="//www.google-analytics.com/analytics.js"></script>-->
		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<script>
			(adsbygoogle = window.adsbygoogle || []).push({google_ad_client: "ca-pub-8023167465237689",enable_page_level_ads: true});
		</script>
	</head>
	<body>
		<div class="wrap">
		<div id="pageHome" class="page out hide tx-c">
			<div class="loading-mask">
				<div class="loading-txt">诗词九宫格</div>
				<div class="loading"></div>
			</div>
			<img src="img/main_logo.png" class="main-logo"/>
			<a class="btn btn-begin" href="#choose-mission">开始</a>
			<a class="btn btn-choose" id="picker">选关</a>
			<a class="btn btn-begin">更多</a>
			<div class="tx-c">好七喵书院出品</div>
		</div>
		<!--
        	时间：2017-06-30
        	描述：选关卡
        -->
		<div id="choose-mission" class="page out">
			<div class="title1">选择关卡</div>
			<div class="mission-blocks"></div>
		</div>
		<!--
			时间：2017-06-30
        	描述：答题页
        -->
		<div id="mission" class="page out">
			<div class="tx-c ofh">
				<span class="missionNum"></span>
				<button class="btn btn-help" onclick="help()">帮助</button>
			</div>
			<div class="words">
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
				<div class="words-block"><span></span></div>
			</div>
			<!--
            	时间：2017-06-30
            	描述：答题区域
            -->
			<div class="answer"></div>
		</div>
		<div class="tip hide"></div>
		<!--
        	时间：2017-07-01
        	描述：帮助弹窗
        -->
		<div class="help tx-c" data-pop>
			<img src="img/QRCode.png" class="qr"/>
			<div>长按扫码查看通关秘籍哦！</div>
		</div>
		<!--
        	时间：2017-07-01
        	描述：答对弹窗
        -->
        <div class="correct-pop" data-pop>
			<div class="correct-content tx-c">
				<div class="answer-txt">窗前明月光</div>
				<div>【出自】</div>
				<div class="poem-info">唐·李白 《静夜思》</div>
				<button class="btn btn-next" style="font-size: 20px;">下一关</button>
				<div style="font-size: 14px;font-weight: normal;margin-top: 10px;">你会背这首诗吗?</div>
				<div class="tx-c" style="margin-top: 10px;">
					<div class="btn btn-recite">我会背</div>
					<div class="btn btn-seen">我见过</div>
					<div class="btn btn-first-see">首次见</div>
				</div>
			</div>
        </div>
		<div class="mask"></div>
		<ins class="adsbygoogle" data-ad-client="ca-pub-8023167465237689"data-ad-slot="7138279852"></ins>
	</div>
		<script src="js/jquery-1.11.1.min.js"></script>
		<script src="js/mobileSelect.js"></script>
		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<script>
			(adsbygoogle = window.adsbygoogle || []).push({});
		</script>
		<script>
			window.onload=function(){
				$(".loading-mask").hide();
			}
			var data;//模拟的json数据
			function getUserData(){
				$.ajax({
					type:"get",
					url:"data.json",
					async:false,
					success:function(json){
						data=json;
					}
				});
			}
			getUserData();
			
			var missionCount=data.missionCount;//关卡数
			var unlockedCount=data.unlockedCount;//解锁的关卡数
			var missionBlocks='';
			var missionArr=[];//存放题目id的数组
			const GRID_COUNT=9;//9宫格9个格子
			//随机打乱题目序号
			for(var n=0;n<missionCount;n++){
				missionArr.push(n);
				//打乱后的题目序号数组
				var sortedMission=missionArr.sort(function(){
					return Math.random()<0.5;
				})
			}
			//生成关卡数
			for(var i=1;i<=missionCount;i++){
				if(i<=unlockedCount){
					missionBlocks+='<div class="mission active" onclick="chooseMission(this)" currentId="'+i+'"><a href="#mission">'+i+'</a></div>';	
				}else{
					missionBlocks+='<div class="mission" onclick="chooseMission(this)" currentId="'+i+'"><span>'+i+'</span></div>';
				}
			}
			$(".mission-blocks").html(missionBlocks)
			$(".mission").each(function(index,item){
				$(this).attr("missionid",sortedMission[index]);
			});
			
			//半透明提示框
			var timer=null;
			window.tip=function(str){
				$(".tip").text(str).show();
				clearTimeout(timer)
				timer=setTimeout(function(){
					$(".tip").hide();
				},1000)
			}
			
			var answerWords='';//答案内容
			var answerLen; //答案长度
			var chooseCount=0;//选择的字数
			var userSelect='';//选择的文本内容
			var currentid=0;//正要闯的关卡序号
			//生成题目
			function showMission(content,mid){
				//生成答案格
				answerWords=data.subjects[mid].answer;
				answerLen=answerWords.length;
				var answerHTML='';
				for(var k=0;k<answerLen;k++){
					answerHTML+='<div class="answer-words empty"></div>';
				}
				$(".answer").html(answerHTML);
				//随机打乱九个字填充九宫格
				var randWords=[].slice.call(content).sort(function(){
					return Math.random()<0.5
				});
				$(".words-block").each(function(index,item){
					$(this).find("span").text(randWords[index]);
				})
			}
			//选择关卡
			function chooseMission(obj,snum){
				if(!$(obj).hasClass("active")){
					tip("关卡未解锁，请完成前面关卡来解锁")
				}else{
					var missionId=$(obj).attr("missionid");
					var content=data.subjects[missionId].words;
					showMission(content,missionId);
					chooseCount=0;
					userSelect='';
					$(".words-block>span").removeClass("empty");
				}
				if(!snum){
					 currentid=$(obj).attr("currentid");
					$(".missionNum").text("当前正在第"+currentid+"关")
				}else{
					$(".missionNum").text("当前正在第"+snum+"关")
				}
			}
			
			//点击九宫格
			$(".words").on("click",".words-block",function(){
				if(chooseCount<answerLen&&!$(this).find("span").hasClass("empty")){
					var _thisText=$(this).find("span").text();
					var index=$(this).index();
					$(this).find("span").text("").addClass("empty");
					$(".answer-words.empty").eq(0).text(_thisText).attr("word-index",index).removeClass("empty");
					chooseCount++;
				}
				if(chooseCount==answerLen){
					$(".answer-words").each(function(index,item){
						userSelect+=$(this).text();
					})
					if(userSelect==answerWords){
						$(".answer-words").addClass("correct")
						$(".correct-pop").show();
						$(".mask").show();
						$(".answer-txt").text(answerWords)
					}else{
						$(".answer-words").addClass("wrong");
						tip("答错了")
					}
					userSelect='';
				}
			})
			//点击答案
			$(".answer").on("click",".answer-words",function(){
				if(chooseCount>0&&!$(this).hasClass("empty")){
					var _thisText=$(this).text();
					$(".answer-words").removeClass("wrong correct")
					var ref_index=$(this).attr("word-index");
					$(this).text("").addClass("empty");
					$(".words-block").eq(ref_index).find("span").text(_thisText).removeClass("empty");
					chooseCount--;
					userSelect='';
				}
			})
			//点击帮助
			function help(){
				$(".mask").show();
				$(".help").show();
			}
			$(".mask").on("click",function(){
				$(this).hide();
				$("[data-pop]").hide();
			})
			//下一题
			function nextMisson(){
				$(".mission").eq(currentid).addClass("active").html("<a href='#mission'>"+(~~currentid+1)+"</a>");
				var nextObj=$(".mission").eq(currentid);
				chooseMission(nextObj);
				$(".correct-pop").hide();
				$(".mask").hide();
				if(currentid>missionCount){
					tip("这已经是最后一关了")
				}else{
					tip("这是第"+currentid+"关");
				}
			}
			$(".btn-next").on("click",function(){
				nextMisson();
			})
		</script>
		<script>
			//选关，picker插件
			var numArr=[0,1,2,3,4,5,6,7,8,9];
			var gw = unlockedCount%10;
			var sw = unlockedCount/10 % 10;
			var bw = unlockedCount/100 % 10;
			var isClose=true;
			var mobileSelect3 = new MobileSelect({
    			trigger: '#picker',
    			title: '关卡选择',
    			wheels: [
                	{data: numArr},
                	{data: numArr},
                	{data: numArr},
            	],
    			position:[0, 0, 1], 
    			transitionEnd:function(indexArr,data){
    				var selectIndex=~~(data.join(""));
    				if(selectIndex>unlockedCount){
    					isClose=false;
    					$(".ensure>a").removeAttr("href");
    				}else{
    					isClose=true;
    					$(".ensure>a").attr("href","#mission");
    				}
    			},
    			callback:function(indexArr, data){
    				$("#picker").text("选关");
    				currentid=~~(data.join(""));
    				if(currentid<=unlockedCount){
  						chooseMission($(".mission").eq(currentid-1),currentid);
  					}else{
  						alert("您选的关卡还未解锁");
  					}
    			}
			});
		</script>
	</body>
</html>
	